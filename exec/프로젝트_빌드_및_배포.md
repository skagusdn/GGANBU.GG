# ğŸ› í”„ë¡œì íŠ¸ ë¹Œë“œ ë° ë°°í¬

## âš™ì‹œìŠ¤í…œ í™˜ê²½ ë° êµ¬ì„±

- OS: Windows10, Linux
- Backend Framework: Spring Boot 2.7.1
- Frontend Framework: NextJS 12.2.5
- DB: mongoDB version v6.0.1, mysql Ver 8.0.30-0ubuntu0.20.04.2 for Linux on x86_64 ((Ubuntu))
- WAS: Gradle
- JVM: javac 1.8.0_342
- Node.js: 16.16.0
- npm: 8.19.1
- Docker: 20.10.12
- Jenkins: 2.361.1
- WEB: Nginx (1.18.0)

<br/><br/><br/>

## DB ì ‘ì† ì •ë³´ ë° í”„ë¡œí¼í‹°
### Database ì ‘ê·¼

> ID: j7c204

> PW: seveneleven

<br/><br/><br/>

## EC2ì— DB ì„¤ì¹˜ ë° ì„¸íŒ…

### MongoDB ì„¤ì¹˜ ë° ì„¸íŒ…
```shell
# ì„¤ì¹˜
$ wget -qO - https://www.mongodb.org/static/pgp/server-6.0.asc | sudo apt-key add -

$ echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu focal/mongodb-org/6.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-6.0.list

# ìš°ë¶„íˆ¬ ì„œë²„ ì—…ë°ì´íŠ¸
$ sudo apt-get update

# ì„¤ì¹˜
$ sudo apt-get install -y mongodb-org

$ echo "mongodb-org hold" | sudo dpkg --set-selections
$ echo "mongodb-org-database hold" | sudo dpkg --set-selections
$ echo "mongodb-org-server hold" | sudo dpkg --set-selections
$ echo "mongodb-mongosh hold" | sudo dpkg --set-selections
$ echo "mongodb-org-mongos hold" | sudo dpkg --set-selections
$ echo "mongodb-org-tools hold" | sudo dpkg --set-selections

# êµ¬ë™
$ sudo systemctl start mongod

# ìƒíƒœ í™•ì¸
$ sudo systemctl status mongod
```


<br/>


### ë¡œì»¬ì— MongoDB Compass ì„¤ì¹˜í•´ì„œ EC2ì— ìˆëŠ” MongoDBì™€ ì—°ê²°í•˜ê¸°
```SQL
-- ìœ ì € ìƒì„±
db.createUser(
  {
    user: "j7c204",
    pwd: "seveneleven", 
    roles: [
      { role: "userAdminAnyDatabase", db: "admin" },
      { role: "readWriteAnyDatabase", db: "admin" }
    ]
  }
)

-- ì…§ë‹¤ìš´
db.adminCommand( { shutdown: 1 } )
```

<br/>

```shell
# ì„¤ì • íŒŒì¼ê³ ì¹˜ê¸°
$ sudo vi /etc/mongod.conf

# ì´ë ‡ê²Œ ê³ ì¹˜ê¸°
security:
  authorization: enabled

# ë‹¤ì‹œ ì‹œì‘
$ sudo systemctl stop mongod
$ systemctl start mongod

# í¬íŠ¸ ì—´ì–´ì£¼ê¸°
$ sudo ufw allow 27017

# ì„¤ì • íŒŒì¼ ê³ ì¹˜ê¸°
$ sudo vi /etc/mongod.conf

# bindIP ë³€ê²½
# network interfaces
net:
  port: 27017
  bindIp: 0.0.0.0
#  bindIp: 127.0.0.1

# ë‹¤ì‹œ ì •ì§€ í›„ ì‹œì‘
$ sudo systemctl stop mongod
$ sudo systemctl start mongod
```

<br/><br/><br/>
### MySQL ì„¤ì¹˜ ë° ì„¸íŒ…

```shell
# ìš°ë¶„íˆ¬ ì„œë²„ ì—…ë°ì´íŠ¸
$ sudo apt-get update

# ì„¤ì¹˜
$ sudo apt-get install mysql-server

# êµ¬ë™
$ sudo systemctl start mysql.service
```

<br/>

```shell
# MySQL ì ‘ì†
$ sudo mysql

# í˜„ì¬ mysqlì—ì„œ ê¸°ë³¸ìœ¼ë¡œ ì„¸íŒ…ë˜ì–´ìˆëŠ” ìœ ì € í™•ì¸
mysql> SELECT user,authentication_string,plugin,host FROM mysql.user;
```


<br/>

```bash
# DBì— ì™¸ë¶€ ì ‘ì†í•˜ê¸° ìœ„í•´ ìƒˆë¡œìš´ ê³„ì • ìƒì„± (% : ì–´ë–¤ ipë¡œë„ ì ‘ì† ê°€ëŠ¥í•˜ë„ë¡ í•˜ê¸° ìœ„í•¨)
mysql> CREATE USER 'ê³„ì •ì´ë¦„'@'%' IDENTIFIED BY 'ë¹„ë°€ë²ˆí˜¸';

# ê¶Œí•œ ë¶€ì—¬
mysql> GRANT ALL PRIVILEGES ON *.* TO 'ê³„ì •ì´ë¦„'@'%' WITH GRANT OPTION;

mysql> FLUSH PRIVILEGES;
```

<br/>

### ë¡œì»¬ì— MySQL Workbench ì„¤ì¹˜í•´ì„œ EC2ì— ìˆëŠ” MySQL ì—°ê²°í•˜ê¸°

```shell
# ì™¸ë¶€ ì ‘ì† í—ˆìš© ì„¤ì •
$ cd /etc/mysql/mysql.conf.d
$ vi mysqld.cnf
```

<br/>
- i ëˆŒëŸ¬ì„œ ì…ë ¥ ëª¨ë“œë¡œ ë³€ê²½ í›„ bind-address ë¥¼ 0.0.0.0 ìœ¼ë¡œ ìˆ˜ì • í›„ ì €ì¥í•˜ê³  ë‚˜ê°€ê¸°


<br/>

```shell
# EC2 ì¸ìŠ¤í„´ìŠ¤ì˜ 3306 í¬íŠ¸ ì—´ê¸°
$ sudo ufw allow 3306

# MySQL ì¬ì‹œì‘
$ sudo systemctl restart mysql.service
```

<br/>

- Workbenchë¡œ ì´ë™

    - Connection Name: í•˜ê³  ì‹¶ì€ Connection ëª…
    - SSH Hostname: ì ‘ì†í•  ë„ë©”ì¸ ë„¤ì„ì´ë‚˜ IP
    - SSH Key File: ì¸ì¦í‚¤
    - Username: ì´ˆë°˜ì— ìƒì„±í•œ MySQL Username

<br/><br/><br/>

## Docker - Jenkinsë¥¼ ì´ìš©í•œ ìë™ë°°í¬

### Dokcer ì„¤ì¹˜

```shell
# ì‚¬ì „ íŒ¨í‚¤ì§€ ì„¤ì¹˜
$ sudo apt update
$ sudo apt-get install -y ca-certificates \
    curl \
    software-properties-common \
    apt-transport-https \
    gnupg \
    lsb-release

# gpgí‚¤ ë‹¤ìš´ë¡œë“œ
$ sudo mkdir -p /etc/apt/keyrings
$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg

$ echo \
    "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
    $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
# Docker ì„¤ì¹˜
$ sudo apt update
$ sudo apt install docker-ce docker-ce-cli containerd.io docker-compose
```

### ì  í‚¨ìŠ¤ ì„¤ì¹˜(ë„ì»¤ ì»¨í…Œì´ë„ˆ) ë° ê³„ì • ìƒì„±
vim docker-compose.yml ëª…ë ¹ì–´ë¥¼ ì…ë ¥ 
```shell
# docker-compose.yml ìˆ˜ì •
$ version: '3'

$ services:
    jenkins:
        image: jenkins/jenkins:lts
        container_name: jenkins
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
            - /jenkins:/var/jenkins_home
        ports:
            - "9090:8080"
        privileged: true
        user: root
``` 
docker-compose.yml íŒŒì¼ì„ ìˆ˜ì •í•œ ë’¤ sudo docker-compose up -d ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•˜ì—¬ ì»¨í…Œì´ë„ˆ ìƒì„±

### ì  í‚¨ìŠ¤ ê³„ì • ìƒì„± ë° í”ŒëŸ¬ê·¸ì¸ 
sudo docker logs jenkins ëª…ë ¹ì–´ë¥¼ í†µí•˜ì—¬ ë‚˜ì˜¨ Administrator passwordë¥¼ ì…ë ¥í•˜ì—¬ ì‹œì‘

### Jenkins ê´€ë¦¬ì°½ì—ì„œ í•„ìš”í•œ í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜
GitLab ê´€ë ¨ í”ŒëŸ¬ê·¸ì¸(GitLab, Generic Webhook Trigger, Gitlab API, GitLab Authentication), Docker ê´€ë ¨ í”ŒëŸ¬ê·¸ì¸(Docker, Docker Commons, Docker Pipeline, Docker API), SSH ì—°ê²° ê´€ë ¨ í”ŒëŸ¬ê·¸ì¸(Publish Over SSH) ì„¤ì¹˜

### ì  í‚¨ìŠ¤ í”„ë¡œì íŠ¸ WebHook ì„¤ì • 
ì  í‚¨ìŠ¤ì—ì„œ ìƒˆë¡œìš´ itemì„ í´ë¦­í›„ GIT URL, íŒ¨ìŠ¤ì›Œë“œ ë° secret Token ê°’ ì…ë ¥
ê·¸ í›„ GitLabì—ì„œ WebHook ì„¤ì •(URL, Secret tokenì„ ì¶”ê°€ í•œ í›„ Triggerì— push event, Merge event ì„¤ì •)


### ì  í‚¨ìŠ¤ì™€ ì—°ê²°ëœ gitLab í”„ë¡œì íŠ¸ë¡œ ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œí•˜ê¸°
sudo docker exec -it jenkins bash ì»¤ë§¨ë“œë¥¼ í†µí•˜ì—¬ ì  í‚¨ìŠ¤ í™˜ê²½ì— ì ‘ê·¼ í›„ ë„ì»¤ ì„¤ì¹˜
```shell
# ì‚¬ì „íŒ¨í‚¤ì§€ ì„¤ì¹˜
$ apt update
$ apt-get install -y ca-certificates \
    curl \
    software-properties-common \
    apt-transport-https \
    gnupg \
    lsb-release

# gpg í‚¤ ë‹¤ìš´ë¡œë“œ
$ mkdir -p /etc/apt/keyrings
$ curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg

$ echo \
    "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian \
    $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null

# ë„ì»¤ ì„¤ì¹˜
$ apt update
$ apt install docker-ce docker-ce-cli containerd.io docker-compose
```

### í”„ë¡œì íŠ¸ì— DockerFile ì‘ì„±
```shell
# frontend ë°°í¬ DockerFile
$ FROM node:16.16.0 as build-stage
$ WORKDIR /var/jenkins_home/workspace/gganbu/frontend
$ COPY package*.json ./
$ RUN npm install --legacy-peer-deps
$ COPY . .
$ RUN npm run build
# FROM nginx:stable-alpine as production-stage

EXPOSE 3000
CMD ["npm", "run","start"]
```

```shell
# backend ë°°í¬ DockerFile
$ FROM openjdk:8-jdk-alpine
$ ARG JAR_FILE=*.jar
$ COPY ${JAR_FILE} app.jar
$ ENTRYPOINT ["java","-jar","/app.jar"]
```


### ì  í‚¨ìŠ¤ì—ì„œ DockerFileì„ ì´ìš©í•˜ì—¬ ë„ì»¤ ì´ë¯¸ì§€ ìƒì„±
êµ¬ì„±-Build íƒ­ì—ì„œ ì•„ë˜ ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•˜ì—¬ Frontend/Backend ë„ì»¤ ì´ë¯¸ì§€ ìƒì„± 
```shell
$ docker image prune -a --force

$ mkdir -p /var/jenkins_home/images_tar
$ cd /var/jenkins_home/workspace/gganbu/frontend/
$ docker build -t next .
$ docker save next > /var/jenkins_home/images_tar/next.tar
$ cd /var/jenkins_home/workspace/gganbu/backend/gganbu/
$ docker build -t spring .
$ docker save spring > /var/jenkins_home/images_tar/spring.tar

$ ls /var/jenkins_home/images_tar
```

### ì  í‚¨ìŠ¤ì—ì„œ ë¹Œë“œí•œ ë„ì»¤ì´ë¯¸ì§€ë¥¼ ë² ì´ìŠ¤ë¡œ ì»¨í…Œì´ë„ˆ ìƒì„±
ì  í‚¨ìŠ¤ êµ¬ì„± - ë¹Œë“œí›„ ì¡°ì¹˜ - Build - send build artifacts over SSH íƒ­ì—ì„œ Source files(ì±„ì›Œ ë„£ê¸°ë§Œ) / Exec command ì‘ì„±
```shell
# Exec Command
$ sudo docker load < /jenkins/images_tar/next.tar
$ sudo docker load < /jenkins/images_tar/spring.tar

$ if (sudo docker ps | grep "next"); then sudo docker stop next; fi
$ if (sudo docker ps | grep "spring"); then sudo docker stop spring; fi


$ sudo docker run -it -d --rm -p 3000:3000 --name next next
$ echo "Run next"
$ sudo docker run -it -d --rm -p 8080:8080  --name spring spring
$ echo "Run spring"
```
<br/><br/><br/>

## NginX ì„¤ì¹˜
```shell
# ì„¤ì¹˜
$ sudo apt install nginx

# nginx ì‹œì‘
$ sudo service nginx start

# nginx status í™•ì¸
$ sudo service nginx status
```


<br/>

- nginxëŠ” ê¸°ë³¸ì ìœ¼ë¡œ 80í¬íŠ¸ë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ 80í¬íŠ¸ ì—´ì–´ì£¼ê¸°

```shell
$ sudo ufw allow 80
```

<br/>

- default ì„¤ì • íŒŒì¼ì— ë“¤ì–´ê°€ì„œ í”„ë¡œì íŠ¸ì— ë§ëŠ” í™˜ê²½ì„¤ì •
```shell
$ sudo vi /etc/nginx/sites-available/default
```


<br/>

- ì„¤ì • ë³€ê²½ í›„ synxax ê²€ì‚¬í•˜ê³  NginX ì¬ì‹œì‘
```shell
$ sudo nginx -t
$ sudo systemctl restart nginx
```

<br/><br/><br/>

## SSL ì ìš©
```shell
# letsencrypt ì„¤ì¹˜
$ sudo apt-get update
$ sudo apt-get install letsencrypt

# NginX ì¤‘ì§€ (80 í¬íŠ¸ ì‚¬ìš© ì‹œ ì—ëŸ¬ë‚  ìˆ˜ ìˆìŒ)
$ sudo systemctl stop nginx

# ì¸ì¦ì„œ ë°œê¸‰
$ sudo letsencrypt certonly --standalone -d [ë„ë©”ì¸ ë„¤ì„]

# ì •ìƒ ë°œê¸‰ ì‹œ /etc/letsencrypt/live/[ë„ë©”ì¸ ë„¤ì„] í´ë” ì•ˆì— í‚¤ë¥¼ ì–»ì„ ìˆ˜ ìˆìŒ
# ex) fullchain.pem, privkey.pem
```

<br/>

- NginX ì„¤ì • íŒŒì¼ ìˆ˜ì •, Proxy ì„¤ì •(c111 ëŒ€ì‹  c204 ì…ë ¥í•˜ê³  íŒŒì¼ êµ¬ì¡°ë‚˜ ìœ„ì¹˜ëŠ” ë‹¤ë¥¼ ìˆ˜ ìˆìŒ)

![image](/uploads/a1f2bbded013758abc7fc240c4a3c518/image.png)


<br/>

- NginX ê°€ë™

```shell
$ sudo systemctl start nginx
```

<br/><br/><br/>


